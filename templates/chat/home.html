{% extends 'chat/base.html' %}
{% block title %} Home {% endblock title %}
{% block content %}
    <h1 style="margin-top: 3px;">My Django Chat Home Page</h1>
    <ul>
        {% for group in groups %}
            <div id="{{ group.uuid}}">
                <li><a>{{ group.name }}</a></li>
                {% comment %} <p>{{group.members.all}}</p> Queryset всех участников{% endcomment %} 
                <p>Список участников {{group.members.all|length}}</p>
                {% if request.user in group.members.all %}
                    <button id="leave-{{ group.uuid }}" class="group_option" value="leave_group {{ group.uuid }}">
                        Leave
                    </button>
                {% else %}
                    <button id="join-{{ group.uuid }}" class="group_option" value="join_group {{ group.uuid }}">
                        Join
                    </button>
                {% endif %}
                {% if request.user in group.members.all %}
                    <button id="open-{{ group.uuid }}" class="group_option" value="open_group {{ group.uuid }}">
                        Open
                    </button>
                {% endif %}
            </div>
        {% endfor %} 


        <h1 id="text_serv" style="text-align: center; margin : 1000">Hello world</h1>
            
    </ul>
{% endblock content %}

{% block script %}
    <script>
        console.log(location.hostname)
        console.log(location.port)
        const socket = new WebSocket("ws://127.0.0.1:8000/")
        
        
        socket.onmessage = function(event){  
                
           message = JSON.parse(event.data)
           type = message.type
           data = message.data
           
            if (type == "leave_group"){
                leave_group_heandler(data)
            }
            else{
                join_group_heandler(data)
            }
        }

        function leave_group_heandler(data){
            
            var leave_button = document.getElementById(`leave-${data}`)
            var open_button = document.getElementById(`open-${data}`)
            leave_button.remove()
            open_button.remove()
            var button = `<button id="join-${data}" class="group_option" value="join_group ${data}">Join</button>`
            var dev_body = document.getElementById(data)
            dev_body.innerHTML += button
            add_event_to_all_buttons()
        }

        function join_group_heandler(data){
            var leave_button = document.getElementById(`join-${data}`)
            leave_button.remove()
            var button = `<button id="leave-${data}" class="group_option" value="leave_group ${data}">Leave</button>`
            var open_button = `<button id="open-${data}" class="group_option" value="open_group ${data}">Open</button>`

            var dev_body = document.getElementById(data)
            dev_body.innerHTML += button
            dev_body.innerHTML += open_button
            add_event_to_all_buttons()
        }

        function add_event_to_all_buttons(){
            const keys = document.querySelectorAll('.group_option');
            keys.forEach(item => {
                item.addEventListener('click', send_event_message)
                }
            ) 
        }
        base_url = `${window.location.hostname}:${window.location.port}/`
        function send_event_message(event){ 
            const {target} = event 
            group = target.value.split(" ")
            if (group[0] == "open_group"){
                window.location.replace(`http://${base_url}groups/${group[1]}`) // тут происходит замена url-a на другой которая обробатывает другая вьюха 
            }
            else {
                data = {
                    'type' : group[0],
                    'data' : group[1],
                }
                
                socket.send(JSON.stringify(data))
                
            }   

            
        }
        
        add_event_to_all_buttons()
    </script> 

    


{% endblock script %}